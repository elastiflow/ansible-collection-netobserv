---
# Using delegate_to: localhost since `lookup` searches for the files locally.
- name: Create TMP dir for ElastiFlow OpenSearch dashboards
  become: false
  delegate_to: localhost
  ansible.builtin.file:
    state: directory
    path: "/tmp/elastiflow/opensearch_dashboards"
    mode: "0755"
  register: _netobserv_flow_opensearch_dashboards_dir
- name: Download OpenSearch Dashboards file
  become: false
  delegate_to: localhost
  ansible.builtin.get_url:
    url: "{{ netobserv_flow_dashboards.opensearch.url }}"
    dest: "{{ _netobserv_flow_opensearch_dashboards_dir.path }}/"
    mode: "0644"
  register: _netobserv_flow_opensearch_dashboards_file
- name: Provision OpenSearch Dashboards
  ansible.builtin.uri:
    url: "{{ netobserv_flow_dashboards.opensearch.dashboards_url }}/api/saved_objects/_import?overwrite={{ netobserv_flow_dashboards.opensearch.override }}"
    method: POST
    status_code: 200
    validate_certs: "{{ netobserv_flow_dashboards.opensearch.tls.validate_certs }}"
    ca_path: "{{ netobserv_flow_dashboards.opensearch.tls.ca_path }}"
    client_cert: "{{ netobserv_flow_dashboards.opensearch.tls.client_cert }}"
    client_key: "{{ netobserv_flow_dashboards.opensearch.tls.client_key }}"
    force_basic_auth: true
    user: "{{ netobserv_flow_config_output_opensearch.username }}"
    password: "{{ netobserv_flow_config_output_opensearch.password }}"
    headers:
      osd-xsrf: "true"
      securitytenant: "global"
    body_format: form-multipart
    body:
      file:
        filename: "{{ _netobserv_flow_opensearch_dashboards_file.dest | basename }}"
        content: "{{ lookup('ansible.builtin.file', _netobserv_flow_opensearch_dashboards_file.dest) }}"
